name: Upstream Sync Check

on:
  schedule:
    # Daily at 08:00 UTC (midnight PST)
    - cron: '0 8 * * *'
  workflow_dispatch: # Manual trigger

permissions:
  contents: read
  issues: write

jobs:
  check-upstreams:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check upstream repos
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run the check script in JSON mode
          set +e
          RESULTS=$(bash scripts/upstream-check.sh --json 2>&1)
          EXIT_CODE=$?
          set -e

          if [[ $EXIT_CODE -eq 2 ]]; then
            echo "::error::Upstream check script failed"
            exit 1
          fi

          # Exit code 1 = no changes
          if [[ $EXIT_CODE -eq 1 ]]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No upstream changes detected."
            exit 0
          fi

          echo "has_changes=true" >> "$GITHUB_OUTPUT"

          # Filter to only changed repos, write to file to avoid shell escaping issues
          echo "$RESULTS" | jq '[.[] | select(.release_changed or .commit_changed)]' > /tmp/changed.json

      - name: Build issue body
        if: steps.check.outputs.has_changes == 'true'
        run: |
          # Use jq to build the entire issue body safely (no shell interpolation of upstream data)
          jq -r '
            "## Upstream Changes Detected\n\n" +
            "*Auto-generated by the daily upstream sync check.*\n\n" +
            (map(
              "### [\(.repo)](https://github.com/\(.repo))\n\n" +
              (if .release_changed then
                "**New release:** `\(.synced_release)` â†’ `\(.latest_release)`\n" +
                "[View release](https://github.com/\(.repo)/releases/tag/\(.latest_release))\n\n"
              else "" end) +
              "**Latest commit:** `\(.latest_commit)` (\(.latest_commit_date)) \(.latest_commit_msg)\n" +
              "[View recent commits](https://github.com/\(.repo)/commits)\n\n" +
              "**Affected Clavain skills:** `\(.skills)`\n\n" +
              "**Checklist:**\n" +
              "- [ ] Review [\(.repo) changelog](https://github.com/\(.repo)/blob/main/CHANGELOG.md) for breaking changes\n" +
              "- [ ] Update affected skill(s) if CLI flags, MCP tools, or concepts changed\n" +
              "- [ ] Verify no phantom references introduced\n\n" +
              "---\n\n"
            ) | join("")) +
            "### After applying updates\n\n" +
            "- [ ] Run `bash scripts/upstream-check.sh --update` to update baseline\n" +
            "- [ ] Commit updated `docs/upstream-versions.json`\n"
          ' /tmp/changed.json > /tmp/issue-body.md

      - name: Create or update issue
        if: steps.check.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check for existing open issue with upstream-sync label
          EXISTING_ISSUE=$(gh issue list \
            --label "upstream-sync" \
            --state open \
            --json number \
            --jq '.[0].number // empty' \
            2>/dev/null || true)

          if [[ -n "$EXISTING_ISSUE" ]]; then
            # Comment on existing issue
            gh issue comment "$EXISTING_ISSUE" --body-file /tmp/issue-body.md
            echo "Commented on existing issue #$EXISTING_ISSUE"
          else
            # Create new issue
            TITLE="Upstream sync: changes detected $(date -u +%Y-%m-%d)"
            gh issue create \
              --title "$TITLE" \
              --label "upstream-sync" \
              --body-file /tmp/issue-body.md
            echo "Created new upstream-sync issue"
          fi
