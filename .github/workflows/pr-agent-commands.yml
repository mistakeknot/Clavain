name: PR Agent Commands

on:
  issue_comment:
    types:
      - created

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  parse-command:
    if: github.event.issue.pull_request != null
    runs-on: ubuntu-latest
    outputs:
      recognized: ${{ steps.parse.outputs.recognized }}
      trusted: ${{ steps.parse.outputs.trusted }}
      mode: ${{ steps.parse.outputs.mode }}
      focus: ${{ steps.parse.outputs.focus }}
      command: ${{ steps.parse.outputs.command }}
      pr_number: ${{ steps.parse.outputs.pr_number }}
      association: ${{ steps.parse.outputs.association }}
      actor: ${{ steps.parse.outputs.actor }}
    steps:
      - id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.comment?.body || "").trim();
            const firstNonEmpty = body.split(/\r?\n/).map(x => x.trim()).find(Boolean) || "";
            const match = firstNonEmpty.match(/^\/clavain:(claude-review|codex-review|dual-review|ai-review)\b(.*)$/i);

            const association = context.payload.comment?.author_association || "NONE";
            const trustedAssociations = new Set(["OWNER", "MEMBER", "COLLABORATOR"]);
            const trusted = trustedAssociations.has(association);

            let recognized = false;
            let mode = "";
            let command = "";
            let focus = "";

            if (match) {
              recognized = true;
              command = `/clavain:${match[1].toLowerCase()}`;
              focus = (match[2] || "").trim();

              if (match[1].toLowerCase() === "claude-review") {
                mode = "claude";
              } else if (match[1].toLowerCase() === "codex-review") {
                mode = "codex";
              } else {
                mode = "both";
              }
            }

            core.setOutput("recognized", recognized ? "true" : "false");
            core.setOutput("trusted", trusted ? "true" : "false");
            core.setOutput("mode", mode);
            core.setOutput("focus", focus);
            core.setOutput("command", command);
            core.setOutput("pr_number", String(context.payload.issue.number));
            core.setOutput("association", association);
            core.setOutput("actor", context.actor);

  deny-untrusted:
    needs: parse-command
    if: needs.parse-command.outputs.recognized == 'true' && needs.parse-command.outputs.trusted != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = Number("${{ needs.parse-command.outputs.pr_number }}");
            const command = "${{ needs.parse-command.outputs.command }}";
            const association = "${{ needs.parse-command.outputs.association }}";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body: [
                `Command \`${command}\` ignored.`,
                "",
                "Only repository `OWNER`, `MEMBER`, or `COLLABORATOR` users can trigger PR agent workflows.",
                `Detected association: \`${association}\`.`
              ].join("\n")
            });

  deny-missing-secrets:
    needs: parse-command
    if: needs.parse-command.outputs.recognized == 'true' && needs.parse-command.outputs.trusted == 'true' && (((needs.parse-command.outputs.mode == 'claude' || needs.parse-command.outputs.mode == 'both') && secrets.ANTHROPIC_API_KEY == '') || ((needs.parse-command.outputs.mode == 'codex' || needs.parse-command.outputs.mode == 'both') && secrets.CODEX_AUTH_JSON == ''))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        env:
          MODE: ${{ needs.parse-command.outputs.mode }}
          HAS_ANTHROPIC: ${{ secrets.ANTHROPIC_API_KEY != '' }}
          HAS_CODEX_AUTH: ${{ secrets.CODEX_AUTH_JSON != '' }}
        with:
          script: |
            const pr = Number("${{ needs.parse-command.outputs.pr_number }}");
            const mode = process.env.MODE || "";
            const hasAnthropic = (process.env.HAS_ANTHROPIC || "") === "true";
            const hasCodexAuth = (process.env.HAS_CODEX_AUTH || "") === "true";
            const missing = [];

            if ((mode === "claude" || mode === "both") && !hasAnthropic) {
              missing.push("ANTHROPIC_API_KEY");
            }
            if ((mode === "codex" || mode === "both") && !hasCodexAuth) {
              missing.push("CODEX_AUTH_JSON");
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body: [
                "PR agent command was recognized but cannot run due to missing required repository secret(s).",
                "",
                `Missing: ${missing.join(", ") || "(unknown)"}`,
                "",
                "Set these in Settings -> Secrets and variables -> Actions."
              ].join("\n")
            });

  claude-review:
    needs: parse-command
    if: needs.parse-command.outputs.recognized == 'true' && needs.parse-command.outputs.trusted == 'true' && (needs.parse-command.outputs.mode == 'claude' || needs.parse-command.outputs.mode == 'both') && secrets.ANTHROPIC_API_KEY != ''
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    outputs:
      result: ${{ steps.claude.outputs.structured_output }}
    steps:
      - name: Checkout PR merge ref
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ needs.parse-command.outputs.pr_number }}/merge
          fetch-depth: 2

      - name: Fetch PR metadata
        id: prmeta
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number("${{ needs.parse-command.outputs.pr_number }}");
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput("base_sha", pr.base.sha);
            core.setOutput("head_sha", pr.head.sha);
            core.setOutput("base_ref", pr.base.ref);
            core.setOutput("title", pr.title || "");
            core.setOutput("body", pr.body || "");

      - name: Ensure base/head refs are available
        run: |
          git fetch --no-tags origin \
            ${{ steps.prmeta.outputs.base_ref }} \
            +refs/pull/${{ needs.parse-command.outputs.pr_number }}/head

      - name: Run Claude review
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are reviewing pull request #${{ needs.parse-command.outputs.pr_number }} for ${{ github.repository }}.

            Review ONLY the changes introduced by this PR.
            Compare this exact range:
            - Base SHA: ${{ steps.prmeta.outputs.base_sha }}
            - Head SHA: ${{ steps.prmeta.outputs.head_sha }}
            - Use: git diff ${{ steps.prmeta.outputs.base_sha }}...${{ steps.prmeta.outputs.head_sha }}

            Command trigger: `${{ needs.parse-command.outputs.command }}`
            Optional focus from commenter: `${{ needs.parse-command.outputs.focus }}`

            Output requirements:
            - Prioritize real defects and regressions.
            - Include file references.
            - Be concise and actionable.
            - If no significant issues are found, say so explicitly.
          claude_args: |
            --max-turns 8
            --allowedTools Read,Grep,Glob,Bash(git diff:*),Bash(git log:*),Bash(git show:*),Bash(rg:*),Bash(cat:*),Bash(ls:*)
            --json-schema {"type":"object","properties":{"response":{"type":"string"}},"required":["response"],"additionalProperties":false}

      - name: Post Claude review comment
        uses: actions/github-script@v7
        env:
          CLAUDE_STRUCTURED: ${{ steps.claude.outputs.structured_output }}
        with:
          script: |
            const prNumber = Number("${{ needs.parse-command.outputs.pr_number }}");
            const actor = "${{ needs.parse-command.outputs.actor }}";
            const command = "${{ needs.parse-command.outputs.command }}";
            const raw = process.env.CLAUDE_STRUCTURED || "";

            let response = "";
            try {
              const parsed = JSON.parse(raw);
              response = String(parsed.response || "").trim();
            } catch (err) {
              response = "";
            }

            if (!response) {
              response = "Claude review completed, but no structured response was returned.";
            }

            const body = [
              "## Clavain Claude Review",
              "",
              `Triggered by @${actor} via \`${command}\`.`,
              "",
              response
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });

  codex-review:
    needs: parse-command
    if: needs.parse-command.outputs.recognized == 'true' && needs.parse-command.outputs.trusted == 'true' && (needs.parse-command.outputs.mode == 'codex' || needs.parse-command.outputs.mode == 'both') && secrets.CODEX_AUTH_JSON != ''
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    outputs:
      result: ${{ steps.codex_exec.outputs.result }}
    steps:
      - name: Checkout PR merge ref
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ needs.parse-command.outputs.pr_number }}/merge
          fetch-depth: 2

      - name: Fetch PR metadata
        id: prmeta
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number("${{ needs.parse-command.outputs.pr_number }}");
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput("base_sha", pr.base.sha);
            core.setOutput("head_sha", pr.head.sha);
            core.setOutput("base_ref", pr.base.ref);
            core.setOutput("title", pr.title || "");
            core.setOutput("body", pr.body || "");

      - name: Ensure base/head refs are available
        run: |
          git fetch --no-tags origin \
            ${{ steps.prmeta.outputs.base_ref }} \
            +refs/pull/${{ needs.parse-command.outputs.pr_number }}/head

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Codex CLI
        run: |
          set -euo pipefail
          npm install -g @openai/codex
          codex --version

      - name: Configure Codex auth
        env:
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}
        run: |
          set -euo pipefail
          mkdir -p ~/.codex
          printf '%s' "${CODEX_AUTH_JSON}" > ~/.codex/auth.json
          chmod 600 ~/.codex/auth.json
          codex login status

      - name: Run Codex review
        id: codex_exec
        env:
          CODEX_HOME: /home/runner/.codex
        run: |
          set -euo pipefail

          codex exec --sandbox read-only -C "$GITHUB_WORKSPACE" -o /tmp/codex-review.md - <<'EOF'
          You are reviewing pull request #${{ needs.parse-command.outputs.pr_number }} for ${{ github.repository }}.

          Review ONLY the changes introduced by this PR using:
          - git diff ${{ steps.prmeta.outputs.base_sha }}...${{ steps.prmeta.outputs.head_sha }}
          - git log --oneline ${{ steps.prmeta.outputs.base_sha }}...${{ steps.prmeta.outputs.head_sha }}

          Command trigger: `${{ needs.parse-command.outputs.command }}`
          Optional focus from commenter: `${{ needs.parse-command.outputs.focus }}`

          Output requirements:
          - Prioritize concrete defects and regressions.
          - Include file references where applicable.
          - Keep feedback concise and actionable.
          - If no significant issues are found, state that explicitly.
          EOF

          if [[ ! -s /tmp/codex-review.md ]]; then
            echo "Codex review completed, but no output was returned." > /tmp/codex-review.md
          fi

          {
            echo "result<<EOF"
            cat /tmp/codex-review.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post Codex review comment
        uses: actions/github-script@v7
        env:
          CODEX_FINAL_MESSAGE: ${{ steps.codex_exec.outputs.result }}
        with:
          script: |
            const prNumber = Number("${{ needs.parse-command.outputs.pr_number }}");
            const actor = "${{ needs.parse-command.outputs.actor }}";
            const command = "${{ needs.parse-command.outputs.command }}";
            const result = (process.env.CODEX_FINAL_MESSAGE || "").trim();

            const body = [
              "## Clavain Codex Review",
              "",
              `Triggered by @${actor} via \`${command}\`.`,
              "",
              result || "Codex review completed, but no output was returned."
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });
