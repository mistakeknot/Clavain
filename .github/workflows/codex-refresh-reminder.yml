name: Codex Refresh Reminder

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  remind:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect Codex-facing changes
        id: detect
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # Initial branch creation push edge case.
          if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            BEFORE="$(git rev-list --max-parents=0 HEAD | tail -n 1)"
          fi

          CHANGED_FILES="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED_FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          if echo "$CHANGED_FILES" | grep -Eq '^(commands/|skills/|\.codex/|docs/README\.codex\.md|scripts/(dispatch|debate|install-codex)\.sh|Makefile|AGENTS\.md|README\.md)'; then
            echo "codex_touched=true" >> "$GITHUB_OUTPUT"
          else
            echo "codex_touched=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Add reminder comment to commit
        if: steps.detect.outputs.codex_touched == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changed = `${{ steps.detect.outputs.changed_files }}`.trim();
            const body = [
              "Codex-facing files changed in this push.",
              "",
              "Reminder:",
              "- Run `make codex-refresh` to update local Codex links and prompts.",
              "- Verify with `make codex-doctor`.",
              "- Restart Codex so it reloads discovered skills/prompts.",
              "",
              "<details><summary>Changed files</summary>",
              "",
              "```text",
              changed || "(none)",
              "```",
              "</details>"
            ].join("\\n");

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body
            });
