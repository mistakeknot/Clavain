name: Upstream Sync Issue Command

on:
  issue_comment:
    types:
      - created

permissions:
  actions: write
  issues: write
  contents: read

jobs:
  parse-command:
    if: github.event.issue.pull_request == null
    runs-on: ubuntu-latest
    outputs:
      recognized: ${{ steps.parse.outputs.recognized }}
      trusted: ${{ steps.parse.outputs.trusted }}
      upstream_issue: ${{ steps.parse.outputs.upstream_issue }}
      dry_run: ${{ steps.parse.outputs.dry_run }}
      issue_number: ${{ steps.parse.outputs.issue_number }}
      actor: ${{ steps.parse.outputs.actor }}
      association: ${{ steps.parse.outputs.association }}
    steps:
      - id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.comment?.body || "").trim();
            const firstNonEmpty = body.split(/\r?\n/).map(x => x.trim()).find(Boolean) || "";
            const match = firstNonEmpty.match(/^\/clavain:upstream-sync\b(.*)$/i);

            const association = context.payload.comment?.author_association || "NONE";
            const trusted = new Set(["OWNER", "MEMBER", "COLLABORATOR"]).has(association);

            const labels = (context.payload.issue?.labels || []).map(l => l.name);
            const upstreamIssue = labels.includes("upstream-sync");

            let recognized = false;
            let dryRun = false;
            if (match) {
              recognized = true;
              const rest = (match[1] || "").toLowerCase();
              if (rest.includes("--dry-run") || rest.includes("dry-run")) {
                dryRun = true;
              }
            }

            core.setOutput("recognized", recognized ? "true" : "false");
            core.setOutput("trusted", trusted ? "true" : "false");
            core.setOutput("upstream_issue", upstreamIssue ? "true" : "false");
            core.setOutput("dry_run", dryRun ? "true" : "false");
            core.setOutput("issue_number", String(context.payload.issue.number));
            core.setOutput("actor", context.actor);
            core.setOutput("association", association);

  deny-untrusted:
    needs: parse-command
    if: needs.parse-command.outputs.recognized == 'true' && needs.parse-command.outputs.trusted != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ needs.parse-command.outputs.issue_number }}"),
              body: [
                "Command `/clavain:upstream-sync` ignored.",
                "",
                "Only repository `OWNER`, `MEMBER`, or `COLLABORATOR` users can trigger this workflow.",
                `Detected association: \`${"${{ needs.parse-command.outputs.association }}"}\`.`
              ].join("\n")
            });

  deny-wrong-issue:
    needs: parse-command
    if: needs.parse-command.outputs.recognized == 'true' && needs.parse-command.outputs.trusted == 'true' && needs.parse-command.outputs.upstream_issue != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ needs.parse-command.outputs.issue_number }}"),
              body: [
                "Command `/clavain:upstream-sync` ignored.",
                "",
                "This command is only allowed on issues labeled `upstream-sync`."
              ].join("\n")
            });

  dispatch:
    needs: parse-command
    if: needs.parse-command.outputs.recognized == 'true' && needs.parse-command.outputs.trusted == 'true' && needs.parse-command.outputs.upstream_issue == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch upstream sync workflow
        uses: actions/github-script@v7
        with:
          script: |
            const dryRun = "${{ needs.parse-command.outputs.dry_run }}" === "true";
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "sync.yml",
              ref: "main",
              inputs: { dry_run: dryRun ? "true" : "false" }
            });

      - name: Confirm dispatch in issue
        uses: actions/github-script@v7
        with:
          script: |
            const dryRun = "${{ needs.parse-command.outputs.dry_run }}" === "true";
            const actionsUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/sync.yml`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ needs.parse-command.outputs.issue_number }}"),
              body: [
                `Triggered \`sync.yml\` via @${"${{ needs.parse-command.outputs.actor }}"}.`,
                "",
                `Mode: \`${dryRun ? "dry_run=true" : "dry_run=false"}\``,
                `Workflow: ${actionsUrl}`
              ].join("\n")
            });
