name: Upstream Sync

on:
  schedule:
    # Weekly on Monday at 08:00 UTC
    - cron: "0 8 * * 1"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (preview changes without writing files)"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Clone upstream repos
        run: |
          set -euo pipefail
          mkdir -p .upstream-work
          while IFS=$'\t' read -r name url branch; do
            target=".upstream-work/$name"
            if [[ -d "$target/.git" ]]; then
              git -C "$target" fetch --all --prune
            else
              git clone --branch "$branch" --single-branch "$url" "$target"
            fi
          done < <(
            python3 - <<'PY'
          import json
          with open("upstreams.json") as f:
              upstreams = json.load(f).get("upstreams", [])
          for u in upstreams:
              name = u.get("name")
              url = u.get("url")
              branch = u.get("branch", "main")
              if name and url:
                  print(f"{name}\t{url}\t{branch}")
          PY
          )

      - name: Run upstream sync
        env:
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          set -euo pipefail
          if [[ "$DRY_RUN" == "true" ]]; then
            scripts/sync-upstreams.sh --dry-run --report /tmp/sync-report.md 2>&1 | tee /tmp/sync-output.txt
          else
            scripts/sync-upstreams.sh --auto --no-ai --report /tmp/sync-report.md 2>&1 | tee /tmp/sync-output.txt
          fi

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Read sync report
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != 'true'
        id: report
        run: |
          if [[ -f /tmp/sync-report.md ]]; then
            {
              echo "content<<REPORT_EOF"
              cat /tmp/sync-report.md
              echo "REPORT_EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "content=No report generated." >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: automated/upstream-sync
          delete-branch: true
          title: "sync: upstream changes from parent repos"
          body: |
            ## Upstream Sync

            Automated sync from upstream repositories via `sync-upstreams.sh --auto --no-ai`.

            **Three-way classification:** Uses `lastSyncedCommit` as ancestor to determine
            who changed each file. COPY/AUTO files applied automatically, KEEP-LOCAL preserved,
            CONFLICT/REVIEW files skipped for manual handling.

            ${{ steps.report.outputs.content }}

            **Protection guards:**
            - Protected files (e.g. `commands/lfg.md`) are never overwritten
            - Deleted agents/commands are never re-created
            - Namespace replacements applied automatically
            - Content blocklist checked post-sync

            ---
            _Generated by [upstream sync workflow](.github/workflows/sync.yml)_
          commit-message: |
            sync: apply upstream changes from parent repos

            Automated sync via sync-upstreams.sh --auto.
          labels: |
            upstream-sync
            automated
