# E4 Prereqs Implementation Plan

**Phase:** planned (as of 2026-02-19)

> **For Claude:** REQUIRED SUB-SKILL: Use clavain:executing-plans to implement this plan task-by-task.

**Goal:** Rebuild the `ic` binary to include schema v7 + interspect commands, wire Clavain's interspect hooks and commands to use proper kernel APIs, and close the four E4 prereq beads (iv-s9vb, iv-njct, iv-ula6, iv-dzbz).

**Architecture:** No new Go code needed — `interspect.go` already exists. Rebuild `ic`, migrate DBs, update two Clavain commands (correction + analysis), ensure durable cursor.

**Tech Stack:** Go (rebuild), Bash (hook/command edits), SQLite (schema migration)

---

### Task 1: Rebuild `ic` Binary + Migrate DBs

**Files:**
- Build: `infra/intercore/cmd/ic/` (no changes, just rebuild)

**Step 1: Rebuild the `ic` binary**

Run:
```bash
cd /root/projects/Interverse/infra/intercore && go build -o /home/mk/.local/bin/ic ./cmd/ic/
```
Expected: binary at `/home/mk/.local/bin/ic` with interspect subcommand

**Step 2: Verify the new binary**

Run: `ic version`
Expected: `ic 0.3.0` with `schema: v7`

Run: `ic interspect query --limit=1`
Expected: empty output (no events yet) or valid JSON, exit code 0

**Step 3: Migrate all project DBs to schema v7**

Run `ic init` in every project directory that has a `.clavain/intercore.db`:
```bash
for dir in /root/projects/Interverse /root/projects/Interverse/os/clavain /root/projects/Interverse/infra/intercore; do
    if [[ -f "$dir/.clavain/intercore.db" ]]; then
        ic --db="$dir/.clavain/intercore.db" init
    fi
done
```
Expected: each prints migration messages (v6 → v7: `interspect_events` table created)

**Step 4: Verify schema v7 in each DB**

Run: `ic --db=.clavain/intercore.db health`
Expected: schema version v7, all tables present

---

### Task 2: Wire E4.4 — Proper Dual-Write in Correction Command

**Files:**
- Modify: `commands/interspect-correction.md:62-85`

**Step 1: Replace `ic state set` workaround with `ic interspect record`**

In `commands/interspect-correction.md`, replace the `## Kernel Dual-Write (best-effort)` section (lines 62-85) with:

```markdown
## Kernel Dual-Write (best-effort)

After the legacy write succeeds, also write to the Intercore kernel's `interspect_events` table so corrections are visible to kernel-side consumers:

` ` `bash
# Dual-write to intercore kernel (fail-open)
if command -v ic &>/dev/null; then
    PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
    RUN_ID=$(ic run current --project="$PROJECT_ROOT" 2>/dev/null) || RUN_ID=""
    ic interspect record \
        --agent="$AGENT_NAME" \
        --type="correction" \
        --reason="$OVERRIDE_REASON" \
        --context="$CONTEXT" \
        --session="$CLAUDE_SESSION_ID" \
        --project="$PROJECT_ROOT" \
        ${RUN_ID:+--run="$RUN_ID"} \
        2>/dev/null || true
fi
` ` `
```

(Note: the triple backticks above have spaces to avoid nesting issues — remove spaces in actual file.)

**Step 2: Verify command renders correctly**

Read back the file and confirm the markdown is valid and the bash code block is properly formatted.

---

### Task 3: Wire E4.6 — Dual-Read in Analysis Command

**Files:**
- Modify: `commands/interspect.md:22-24`

**Step 1: Add kernel query after legacy query**

In `commands/interspect.md`, after the `_interspect_ensure_db` + `DB=$(_interspect_db_path)` block (line 22-24), add a new section to also query the kernel:

Insert after line 24 (`DB=$(_interspect_db_path)`):

```markdown

## Kernel Evidence (dual-read)

Also query the Intercore kernel's `interspect_events` table for corrections that may not yet be in the legacy store:

` ` `bash
KERNEL_EVENTS=""
if command -v ic &>/dev/null; then
    KERNEL_EVENTS=$(ic interspect query --limit=200 2>/dev/null) || KERNEL_EVENTS=""
fi
` ` `

If kernel events are available, note the count in the health summary. Full merge logic is handled by `_interspect_get_classified_patterns` reading from the legacy store — the kernel consumer (E4.5) materializes kernel events into the legacy DB at session start. The dual-read here provides visibility into any events not yet consumed.
```

**Step 2: Update the Evidence Health Summary section**

In the report format section (around line 89-95), add a line for kernel events:

After `- Active sessions (last 7d): {recent}`, add:
```
- Kernel events (interspect_events): {kernel_count} (via ic interspect query)
```

Count kernel events from the `KERNEL_EVENTS` variable:
```bash
KERNEL_COUNT=0
if [[ -n "$KERNEL_EVENTS" ]]; then
    KERNEL_COUNT=$(echo "$KERNEL_EVENTS" | wc -l)
fi
```

---

### Task 4: Ensure Durable Cursor Registration

**Files:**
- Modify: `hooks/lib-interspect.sh` (near `_interspect_ensure_db`)

**Step 1: Add cursor registration to ensure_db**

In `hooks/lib-interspect.sh`, find the `_interspect_ensure_db()` function and add a durable cursor registration call after the schema migrations. Add at the end of the function, before the closing `}`:

```bash
# Ensure durable cursor for kernel event consumer (E4.2)
# Only runs if ic is available; idempotent (register is a no-op if cursor exists)
if command -v ic &>/dev/null; then
    ic events cursor register interspect-consumer --durable 2>/dev/null || true
fi
```

**Step 2: Verify syntax**

Run: `bash -n hooks/lib-interspect.sh`
Expected: no output (clean syntax)

---

### Task 5: Verify + Close Beads + Commit

**Step 1: End-to-end verification**

Test `ic interspect record`:
```bash
ic interspect record --agent=test-agent --type=test --reason="verification" --session=test-session --project=/tmp
```
Expected: prints an ID number

Test `ic interspect query`:
```bash
ic interspect query --agent=test-agent --limit=5
```
Expected: JSON line(s) with the test event

Clean up test event:
```bash
sqlite3 .clavain/intercore.db "DELETE FROM interspect_events WHERE agent_name='test-agent';"
```

**Step 2: Close beads**

```bash
cd /root/projects/Interverse
bd close iv-s9vb --reason="Verified: interspect-session.sh calls ic run current, stores run_id. Schema migration in _interspect_ensure_db."
bd close iv-njct --reason="Verified: _interspect_consume_kernel_events() in lib-interspect.sh consumes kernel events at session start. Durable cursor registration added."
bd close iv-ula6 --reason="Shipped: /interspect:correction now uses ic interspect record for kernel dual-write (replaced ic state set workaround)."
bd close iv-dzbz --reason="Shipped: /interspect analysis shows kernel event count via ic interspect query dual-read."
```

**Step 3: Commit**

```bash
cd /root/projects/Interverse/os/clavain
git add commands/interspect-correction.md commands/interspect.md hooks/lib-interspect.sh
git commit -m "feat(interspect): wire E4 prereqs — proper kernel dual-write/read + durable cursor"
```

**Step 4: Bump version**

Run: `bash scripts/bump-version.sh 0.6.48`
(If post-bump hook fails on regex, manually update version in plugin.json, agent-rig.json, PRD.md, marketplace.)

```bash
git add -A
git commit -m "chore: bump to 0.6.48 — E4 prereqs complete"
```

---
