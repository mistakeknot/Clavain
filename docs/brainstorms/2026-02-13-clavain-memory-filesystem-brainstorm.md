# Brainstorm: .clavain/ Agent Memory Filesystem Contract

**Bead:** Clavain-d4ao
**Phase:** brainstorm (as of 2026-02-14T05:58:01Z)

## Problem Statement

Clavain currently scatters agent memory across multiple locations with no unified contract:
- **Compound knowledge**: `config/flux-drive/knowledge/` (plugin-internal, not per-project)
- **Session handoff**: `HANDOFF.md` in project root (ephemeral, overwritten each session)
- **Engineering docs**: `docs/solutions/` (per-project, but tied to `/compound` skill)
- **Domain cache**: `.claude/flux-drive.yaml` (auto-generated by detect-domains.py)
- **Beads state**: `.beads/` (external tool, not Clavain-controlled)

There is no shared filesystem contract that tells agents "here's where project memory lives, here's how to read/write it, here's what's ephemeral vs. durable."

## Why Now

1. **auto-compound fires but has nowhere project-local to write** — knowledge goes to the plugin's global `config/` rather than living with the project
2. **session-handoff writes HANDOFF.md to root** — pollutes the repo, gets overwritten, no history
3. **No cross-session continuity** — each session starts cold unless beads are consulted manually
4. **Downstream features need it** — scenarios, pipelines, provenance, and CXDB-lite all assume `.clavain/` exists

## Design Constraints

1. **Must work today** — only depend on features Clavain already has (hooks, commands, skills)
2. **Must be per-project** — not global plugin state; travels with the repo
3. **Must be gitignore-friendly** — some dirs are ephemeral (scratch, runs), some are durable (learnings, index)
4. **Must not require new MCP servers or external tools** — plain files, YAML/JSON/MD
5. **Must not conflict with `.claude/`** — that's Claude Code's own directory
6. **Must be opt-in** — projects that don't use Clavain shouldn't have `.clavain/` forced on them

## Proposed Directory Structure

```
.clavain/
├── index/                  # Search-friendly markdown indexes (auto-generated)
│   ├── skills.md           # What skills are available + when to use them
│   ├── architecture.md     # Key architectural decisions for this project
│   └── gotchas.md          # Known pitfalls and workarounds
├── learnings/              # Curated durable knowledge (feeds /compound)
│   ├── *.md                # Individual learning entries with YAML frontmatter
│   └── README.md           # Index of all learnings
├── scratch/                # Ephemeral working state (gitignored)
│   ├── handoff.md          # Session handoff (replaces root HANDOFF.md)
│   ├── runs/               # Run manifests and checkpoints
│   │   └── <run-id>/       # Per-run artifacts
│   └── cache/              # Transient computation cache
├── contracts/              # API contracts, invariants, SLOs (durable)
│   └── *.md                # Contract documents
└── weather.md              # Model routing preferences (Clavain writes, reads)
```

## What Each Directory Does

### `index/` — Auto-Generated Search Indexes
- **Written by**: `/index:update` command, auto-compound hook extension
- **Read by**: Session-start hook (injects top-level summary), agents needing project context
- **Lifecycle**: Regenerated on demand; safe to delete and recreate
- **Format**: Markdown with YAML frontmatter (`generated: <timestamp>`, `sources: [list]`)
- **Example**: `architecture.md` contains a summary of key design decisions extracted from README, AGENTS.md, CLAUDE.md, and any `docs/adr/` files

### `learnings/` — Curated Durable Knowledge
- **Written by**: `/compound` command (redirected from global `config/flux-drive/knowledge/`)
- **Read by**: fd-* review agents (injected as context), `/lfg` execute phase
- **Lifecycle**: Permanent; subject to decay rules (archive after 10 reviews without re-confirmation)
- **Format**: Markdown with YAML frontmatter matching existing knowledge format:
  ```yaml
  ---
  title: "Shell stat fallback gives epoch zero"
  category: correctness
  severity: medium
  provenance: independent
  date: 2026-02-12
  ---
  ```
- **Migration**: Existing `config/flux-drive/knowledge/*.md` entries are the "global defaults"; project-local learnings take precedence

### `scratch/` — Ephemeral Working State (Gitignored)
- **Written by**: session-handoff hook, /lfg run checkpoints, any hook needing temp state
- **Read by**: Session-start hook (reads handoff.md for continuity), resume logic
- **Lifecycle**: Ephemeral — cleaned up by session-start or manually
- **Key change**: `HANDOFF.md` moves from project root to `.clavain/scratch/handoff.md`

### `contracts/` — API Contracts and Invariants (Durable)
- **Written by**: Manual or via future `/contract:new` command
- **Read by**: fd-correctness, fd-safety during reviews
- **Lifecycle**: Permanent; versioned alongside code
- **Purpose**: Captures "this API must always return X given Y" type invariants

### `weather.md` — Model Routing Preferences
- **Written by**: `/model-routing` command or manual
- **Read by**: Session-start hook, agent dispatch logic
- **Lifecycle**: Semi-permanent; updated when model landscape changes
- **Format**: Simple markdown with model preferences per task type

## Gitignore Contract

Projects using `.clavain/` should add:
```gitignore
# Clavain agent memory — ephemeral state
.clavain/scratch/
```

Everything else (index/, learnings/, contracts/, weather.md) is **committed** — it's project knowledge that should travel with the repo.

## Hook Integration Changes

### session-start.sh
- Check for `.clavain/` existence; if present, inject summary from `index/` into `additionalContext`
- Read `.clavain/scratch/handoff.md` if present; inject as "Previous session left off at..."

### session-handoff.sh
- Write to `.clavain/scratch/handoff.md` instead of root `HANDOFF.md`
- Create `.clavain/scratch/` if `.clavain/` exists but `scratch/` doesn't

### auto-compound.sh
- When `.clavain/learnings/` exists, write learnings there (project-local)
- When it doesn't exist, fall back to current behavior (global `config/flux-drive/knowledge/`)

## New Commands

### `/index:update`
- Scans project for key artifacts (README, AGENTS.md, CLAUDE.md, docs/adr/, .beads/)
- Generates/refreshes `.clavain/index/` markdown files
- Idempotent — safe to run anytime

### `/genrefy`
- Reorganizes `.clavain/learnings/` taxonomy
- Rewrites indexes
- Preserves backlinks
- Inspired by StrongDM's "genrefying" concept

### `/clavain:init`
- Scaffolds `.clavain/` directory structure
- Adds `.clavain/scratch/` to `.gitignore`
- Creates initial `weather.md` from current `/model-routing` state
- Creates empty `index/` and `learnings/` directories

## Migration Strategy

1. **Phase 1 (this bead)**: Define contract, implement `/clavain:init`, update session-handoff to use `.clavain/scratch/` when available
2. **Phase 2**: Add `/index:update` and `/genrefy` commands
3. **Phase 3**: Migrate auto-compound to write project-local learnings
4. **Phase 4**: Wire fd-* agents to read `.clavain/learnings/` during reviews

## What This Does NOT Include

Explicitly deferred to downstream beads:
- **Scenarios** (`.clavain/scenarios/`) — Clavain-fz77
- **Pipelines** (`.clavain/pipelines/`) — Clavain-kvlq
- **CXDB-lite** (`.clavain/blobs/`, SQLite) — Clavain-re7g
- **Provenance** (`.clavain/provenance/`, `policy.yml`) — Clavain-lkji

These are extension points. The contract here defines the base directories; downstream beads add their own subdirectories following the same conventions.

## Open Questions

1. **Should `/compound` always write project-local when `.clavain/` exists?** Or should it write to both global (plugin) and local (project)? Global knowledge benefits all projects; local knowledge is project-specific.

2. **How aggressive should `/index:update` be?** Full project scan (slow, comprehensive) vs. incremental (fast, may miss things)?

3. **Should `.clavain/` be auto-created?** Or only via explicit `/clavain:init`? Auto-creation is convenient but violates the opt-in constraint.

4. **What about projects that aren't git repos?** The gitignore contract assumes git. Should scratch/ use a different mechanism?

## Success Criteria

- `.clavain/` exists as a documented, consistent convention
- session-handoff writes to `.clavain/scratch/` when available (no more root HANDOFF.md pollution)
- `/clavain:init` scaffolds the directory correctly
- Existing hooks detect and respect `.clavain/` presence
- The contract is extensible for downstream beads without breaking changes
