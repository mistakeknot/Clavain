#!/usr/bin/env bash
# clavain-cli — thin shim. Delegates to Go binary if available, falls back to Bash.
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GO_BIN="$SCRIPT_DIR/clavain-cli-go"

# Try Go binary first
if [[ -x "$GO_BIN" ]]; then
    exec "$GO_BIN" "$@"
fi

# Auto-build if Go is available
if command -v go &>/dev/null && [[ -d "$SCRIPT_DIR/../cmd/clavain-cli" ]]; then
    if go build -C "$SCRIPT_DIR/../cmd/clavain-cli" -mod=readonly -o "$GO_BIN" . 2>/dev/null; then
        exec "$GO_BIN" "$@"
    fi
fi

# Fall back to Bash implementation
HOOKS_DIR="$(dirname "$SCRIPT_DIR")/hooks"
export SPRINT_LIB_PROJECT_DIR="${SPRINT_LIB_PROJECT_DIR:-.}"
export GATES_PROJECT_DIR="${GATES_PROJECT_DIR:-.}"
source "${HOOKS_DIR}/lib-sprint.sh"
source "${HOOKS_DIR}/lib-gates.sh"

case "${1:-help}" in
    # ── Gate / Phase commands ────────────────────────────────────
    advance-phase)       shift; advance_phase "$@" ;;
    enforce-gate)        shift; enforce_gate "$@" ;;
    infer-bead)          shift; phase_infer_bead "$@" ;;

    # ── Sprint state commands ────────────────────────────────────
    set-artifact)        shift; sprint_set_artifact "$@" ;;
    get-artifact)        shift; sprint_get_artifact "$@" ;;
    record-phase)        shift; sprint_record_phase_completion "$@" ;;
    sprint-advance)      shift; sprint_advance "$@" ;;
    sprint-find-active)  shift; sprint_find_active "$@" ;;
    sprint-create)       shift; sprint_create "$@" ;;
    sprint-claim)        shift; sprint_claim "$@" ;;
    sprint-release)      shift; sprint_release "$@" ;;
    sprint-read-state)   shift; sprint_read_state "$@" ;;
    sprint-next-step)    shift; sprint_next_step "$@" ;;
    sprint-budget-remaining) shift; sprint_budget_remaining "$@" ;;
    infer-action)        shift; sprint_infer_action "$@" ;;

    # ── Budget commands ────────────────────────────────────────
    budget-total)        shift; sprint_budget_total "$@" ;;
    sprint-budget-stage) shift; sprint_budget_stage "$@" ;;
    sprint-budget-stage-remaining) shift; sprint_budget_stage_remaining "$@" ;;
    sprint-budget-stage-check)     shift; sprint_budget_stage_check "$@" ;;
    sprint-stage-tokens-spent)     shift; sprint_stage_tokens_spent "$@" ;;
    sprint-record-phase-tokens)    shift; sprint_record_phase_tokens "$@" ;;
    sprint-should-pause) shift; sprint_should_pause "$@" ;;

    # ── Complexity commands ──────────────────────────────────────
    classify-complexity) shift; sprint_classify_complexity "$@" ;;
    complexity-label)    shift; sprint_complexity_label "$@" ;;

    # ── Child bead management ────────────────────────────────────
    close-children)           shift; sprint_close_children "$@" ;;
    close-parent-if-done)     shift; sprint_close_parent_if_done "$@" ;;

    # ── Bead claiming ──────────────────────────────────────────────
    bead-claim)              shift; bead_claim "$@" ;;
    bead-release)            shift; bead_release "$@" ;;

    # ── Checkpoint commands ──────────────────────────────────────
    checkpoint-write)    shift; checkpoint_write "$@" ;;
    checkpoint-read)     shift; checkpoint_read "$@" ;;
    checkpoint-validate) shift; checkpoint_validate "$@" ;;
    checkpoint-clear)    shift; checkpoint_clear "$@" ;;
    checkpoint-completed-steps) shift; checkpoint_completed_steps "$@" ;;
    checkpoint-step-done) shift; checkpoint_step_done "$@" ;;

    # ── Agent tracking ──────────────────────────────────────────
    sprint-track-agent)  shift; sprint_track_agent "$@" ;;
    sprint-complete-agent) shift; sprint_complete_agent "$@" ;;
    sprint-invalidate-caches) shift; sprint_invalidate_caches "$@" ;;

    help|--help|-h)
        if [[ -x "$GO_BIN" ]]; then "$GO_BIN" help; else cat <<'HELP'
Usage: clavain-cli <command> [args...] (Bash fallback mode)
Run with Go binary for full command list.
HELP
        fi
        ;;
    *)
        echo "clavain-cli: unknown command '${1}'" >&2
        echo "Run 'clavain-cli help' for usage." >&2
        exit 1
        ;;
esac
