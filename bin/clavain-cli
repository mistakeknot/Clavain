#!/usr/bin/env bash
# clavain-cli — single dispatcher for sprint + gate library functions.
# Wraps 20 library functions as clean subcommands so command markdown files
# produce short, readable Bash invocations instead of multi-line source blocks.
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HOOKS_DIR="$(dirname "$SCRIPT_DIR")/hooks"

export SPRINT_LIB_PROJECT_DIR="${SPRINT_LIB_PROJECT_DIR:-.}"
export GATES_PROJECT_DIR="${GATES_PROJECT_DIR:-.}"

source "${HOOKS_DIR}/lib-sprint.sh"
source "${HOOKS_DIR}/lib-gates.sh"

case "${1:-help}" in
    # ── Gate / Phase commands ────────────────────────────────────
    advance-phase)       shift; advance_phase "$@" ;;
    enforce-gate)        shift; enforce_gate "$@" ;;
    infer-bead)          shift; phase_infer_bead "$@" ;;

    # ── Sprint state commands ────────────────────────────────────
    set-artifact)        shift; sprint_set_artifact "$@" ;;
    record-phase)        shift; sprint_record_phase_completion "$@" ;;
    sprint-advance)      shift; sprint_advance "$@" ;;
    sprint-find-active)  shift; sprint_find_active "$@" ;;
    sprint-create)       shift; sprint_create "$@" ;;
    sprint-claim)        shift; sprint_claim "$@" ;;
    sprint-release)      shift; sprint_release "$@" ;;
    sprint-read-state)   shift; sprint_read_state "$@" ;;
    sprint-next-step)    shift; sprint_next_step "$@" ;;
    sprint-budget-remaining) shift; sprint_budget_remaining "$@" ;;

    # ── Complexity commands ──────────────────────────────────────
    classify-complexity) shift; sprint_classify_complexity "$@" ;;
    complexity-label)    shift; sprint_complexity_label "$@" ;;

    # ── Child bead management ────────────────────────────────────
    close-children)      shift; sprint_close_children "$@" ;;

    # ── Checkpoint commands ──────────────────────────────────────
    checkpoint-write)    shift; checkpoint_write "$@" ;;
    checkpoint-read)     shift; checkpoint_read "$@" ;;
    checkpoint-validate) shift; checkpoint_validate "$@" ;;
    checkpoint-clear)    shift; checkpoint_clear "$@" ;;

    help)
        cat <<'EOF'
Usage: clavain-cli <command> [args...]

Gate / Phase:
  advance-phase       <bead_id> <phase> <reason> <artifact_path>
  enforce-gate        <bead_id> <target_phase> <artifact_path>
  infer-bead          <artifact_path>

Sprint State:
  set-artifact        <bead_id> <type> <path>
  record-phase        <bead_id> <phase>
  sprint-advance      <bead_id> <current_phase> [artifact_path]
  sprint-find-active
  sprint-create       <title>
  sprint-claim        <bead_id> <session_id>
  sprint-release      <bead_id>
  sprint-read-state   <bead_id>
  sprint-next-step    <phase>
  sprint-budget-remaining <bead_id>

Complexity:
  classify-complexity <bead_id> <description>
  complexity-label    <score>

Children:
  close-children      <bead_id> <reason>

Checkpoints:
  checkpoint-write    <bead_id> <phase> <step> <plan_path>
  checkpoint-read
  checkpoint-validate
  checkpoint-clear
EOF
        ;;

    *)
        echo "clavain-cli: unknown command '${1}'" >&2
        echo "Run 'clavain-cli help' for usage." >&2
        exit 1
        ;;
esac
