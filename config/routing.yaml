# Model routing policy for Clavain (Track B1+B2: Static + Complexity-Aware Routing)
#
# Three namespaces:
#   subagents:   Claude Code agents (haiku/sonnet/opus/inherit)
#   dispatch:    Codex CLI agents (concrete model IDs)
#   complexity:  Task complexity → model override layer (B2)
#
# Subagent resolution order (highest priority first):
#   complexity override (if enabled+matching) > overrides[agent] > phases[phase].categories[cat] > phases[phase].model > defaults.categories[cat] > defaults.model
#
# Dispatch resolution:
#   complexity tier promotion/demotion (if enabled) > tiers[name].model, with fallback chain
#
# When this file is absent, all consumers fall back to their existing defaults.

subagents:
  defaults:
    model: sonnet
    categories:
      research: haiku
      review: sonnet
      workflow: sonnet
      synthesis: haiku
      explore: haiku
      general-purpose: sonnet

  phases:
    brainstorm:
      model: opus
      categories:
        # Research agents stay cheap even during brainstorm
        research: haiku
    brainstorm-reviewed:
      model: opus
    strategized:
      model: opus
    planned:
      model: sonnet
    executing:
      model: sonnet
      categories:
        # Review agents get opus during execution (quality gates run here)
        review: opus
    shipping:
      model: sonnet
    reflect:
      model: sonnet
    done:
      model: sonnet

dispatch:
  tiers:
    fast:
      model: gpt-5.3-codex-spark
      description: Scoped read-only tasks, exploration, verification, quick reviews
    fast-clavain:
      model: gpt-5.3-codex-spark-xhigh
      description: Clavain interserve-mode default for read-only/administrative tasks
    deep:
      model: gpt-5.3-codex
      description: Generative tasks, implementation, complex reasoning, debates
    deep-clavain:
      model: gpt-5.3-codex-xhigh
      description: Clavain interserve-mode high-complexity/research/flux-drive dispatch

  # Fallback if a tier is unavailable (API returns model_not_found)
  fallback:
    fast: deep
    fast-clavain: deep-clavain
    deep-clavain: deep

# Complexity-aware routing (Track B2)
#
# When enabled, task complexity signals (token count, file scope, reasoning depth)
# classify each task into a tier (C1-C5). Tiers can override the base model selection
# from subagents: and promote/demote dispatch tiers.
#
# mode:
#   off     — Zero-cost bypass. Complexity section is not parsed. (default)
#   shadow  — Classify and log what *would* change, but apply base routing.
#   enforce — Classify and apply complexity overrides.
#
# Zero-cost guarantee: when mode=off, routing_resolve_model behaves identically
# to B1 with no extra function calls, no config parsing, no overhead.
complexity:
  mode: off

  # Classification thresholds — a task's complexity tier is the highest tier
  # whose ANY threshold is met. Evaluated top-down (C5 first).
  # Signals: prompt_tokens (int), file_count (int), reasoning_depth (1-5 scale)
  tiers:
    C5:
      description: Architectural — multi-system design, novel algorithms, cross-cutting concerns
      prompt_tokens: 4000
      file_count: 15
      reasoning_depth: 5
    C4:
      description: Complex — multi-file implementation, significant refactoring
      prompt_tokens: 2000
      file_count: 8
      reasoning_depth: 4
    C3:
      description: Moderate — single-component feature, standard patterns
      prompt_tokens: 800
      file_count: 4
      reasoning_depth: 3
    C2:
      description: Simple — focused change, well-understood scope
      prompt_tokens: 300
      file_count: 2
      reasoning_depth: 2
    C1:
      description: Trivial — typo fix, config tweak, single-line change
      prompt_tokens: 0
      file_count: 0
      reasoning_depth: 1

  # Per-tier model overrides. These layer on TOP of base B1 resolution.
  # Only specified fields override; unspecified fields inherit from B1.
  # "inherit" means "use B1 result" (explicit passthrough).
  overrides:
    C5:
      subagent_model: opus
      dispatch_tier: deep
    C4:
      subagent_model: opus
      dispatch_tier: deep
    C3:
      subagent_model: inherit
      dispatch_tier: inherit
    C2:
      subagent_model: haiku
      dispatch_tier: fast
    C1:
      subagent_model: haiku
      dispatch_tier: fast
